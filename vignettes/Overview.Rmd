---
title: "Overview of Statistical Approaches for Causal Mediation Analysis"
author: "Baoyi Shi"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Overview of Causal Mediation Analysis Approaches and Sensitivity Analysis Approaches}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This document describes how the six causal mediation analysis approaches including *the regression-based approach* by [Valeri et al. (2013)](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3659198/) and [Vanderweele et al. (2014)](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4287269/), 
*the weighting-based approach* by [Vanderweele et al. (2014)](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4287269/), *the inverse odd-ratio weighting approach* by [Tchetgen Tchetgen et al. (2013)](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3954805/), *the natural effect model* by
[Vansteelandt et al. (2012)](https://www.degruyter.com/view/journals/em/1/1/article-p131.xml?language=en), *the marginal structural model* by [VanderWeele 
et al. (2009)](https://pubmed.ncbi.nlm.nih.gov/19234398), and *the g-formula approach* by [Lin et al. (2017)](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5285457/) are implemented by the `cmest` function in the `CMAverse` package. See the publications for methodological details of these approaches.

We categorize the approaches according to whether the approach deals with post-exposure confounding. The outcome, the exposure and the pre-exposure confounder(s) are denoted as $Y$, $A$ and $C$ respectively. The set of mediator(s) $\{M_p\}_{p=1,...,k}$ is denoted as $M$ and $M=(M_1,...,M_k)$ follows the temporal order of the mediators. The set of post-exposure confounder(s) $\{L_q\}_{q=1,...,s}$ is denoted as $L$ and $L=(L_1,...,L_s)$ follows the temporal order of the post-exposure confounder(s). 

# Pre-exposure Confounding

## DAG

```{r echo=F,warning=F,message=F,fig.width=6,fig.height=3}
library(dagitty)
g1 <- dagitty( "dag {
    A -> Y
    A -> M -> Y
    C -> A
    C -> M
    C -> Y
}")
coordinates(g1) <- list(x=c(A=0,Y=4,M=2,C=0.2),y=c(A=0,Y=0,M=-0.8,C=-1))
plot(g1)
```

## Estimands

### Effect Decomposition on the Difference Scale

```{r echo=F,warning=F,message=F}
library(knitr)
library(dplyr)
library(kableExtra)
tb1 <- data.frame(c("Controlled Direct Effect", "Pure Natural Direct Effect",
                    "Total Natural Direct Effect", "Pure Natural Indirect Effect",
                    "Total Natural Indirect Effect", "Total Effect", "Proportion Mediated",
                    "Reference Interaction", "Mediated Interaction", "Proportion $CDE$",
                    "Proportion $INT_{ref}$", "Proportion $INT_{med}$", "Proportion $PNIE$",
                    "Overall Proportion Mediated", 
                    "Overall Proportion Attributable to Interaction", 
                    "Overall Proportion Eliminated"),
           c("$CDE$", "$PNDE$", "$TNDE$", "$PNIE$", "$TNIE$", "$TE$", "$PM$", "$INT_{ref}$", 
             "$INT_{med}$", "$prop^{CDE}$", "$prop^{INT_{ref}}$", "$prop^{INT_{med}}$", 
             "$prop^{PNIE}$", "$overall^{PM}$", "$overall^{INT}$", "$overall^{PE}$"),
           c("$E[Y_{am}-Y_{a^*m}]$", "$E[Y_{aM_a^*}-Y_{a^*M_a^*}]$", "$E[Y_{aM_a}-Y_{a^*M_a}]$", 
             "$E[Y_{a^*M_a}-Y_{a^*M_a^*}]$", "$E[Y_{aM_a}-Y_{aM_a^*}]$", "$PNDE+TNIE$", 
             "$TNIE/TE$", "$PNDE-CDE$", "$TNIE-PNIE$", "$CDE/TE$", 
             "$INT_{ref}/TE$", "$INT_{med}/TE$", "$PNIE/TE$", 
             "$(PNIE+INT_{med})/TE$", "$(INT_{ref}+INT_{med})/TE$", 
             "$(INT_{ref}+INT_{med}+PIE)/TE$"))
colnames(tb1) <- c("Full Name", "Abbreviation", "Formula")
knitr::kable(tb1, escape = FALSE, caption = "Description of Causal Effects on the Difference Scale") %>%
  footnote(general = "$a$ and $a^*$ are two reference values of the exposure. $m$ is the reference value of the mediator. $M_a$ denote the counterfactual values of $M$ if A is set to be $a$. $Y_{am}$ denote the counterfactual values of $Y$ if $M$ is set to be $m$ and A is set to be $a$. $Y_{aMa*}$ denotes the counterfactual value of $Y$ if $A$ is set to be $a$ and M is set to be $M_a^*$.") %>%
  column_spec(1, width = "20em") %>%
  column_spec(2, width = "8em") %>%
  column_spec(3, width = "10em") %>%
  kable_styling(bootstrap_options = c("bordered", "striped", "hover", "responsive", "condensed"))
```

For continuous outcome, causal effects are estimated on the difference scale. we directly estimate $CDE$, $PNDE$, $TNDE$, $PNIE$ and $TNIE$ and other effects are calculated from $CDE$, $PNDE$, $TNDE$, $PNIE$ and $TNIE$.

### Effect Decomposition on the Ratio Scale

```{r echo=F,warning=F,message=F}
tb2 <- data.frame(c("Controlled Direct Effect", "Pure Natural Direct Effect",
                    "Total Natural Direct Effect", "Pure Natural Indirect Effect",
                    "Total Natural Indirect Effect", "Total Effect", "Proportion Mediated",
                    "Excess RR due to Controlled Direct Effect", 
                    "Excess RR due to Reference Interaction", 
                    "Excess RR due to Mediated Interaction", 
                    "Excess RR due to Pure Natural Indirect Effect", 
                    "Proportion $err^{CDE}$",
                    "Proportion $err^{INT_{ref}}$", "Proportion $err^{INT_{med}}$", 
                    "Proportion $err^{PIE}$",
                    "Overall Proportion Mediated", 
                    "Overall Proportion Attributable to Interaction", 
                    "Overall Proportion Eliminated"),
           c("$rr^{CDE}$", "$rr^{PNDE}$", "$rr^{TNDE}$", "$rr^{PNIE}$", "$rr^{TNIE}$", "$TE$", 
             "$PM$", "$err^{CDE}$", "$err^{INT_{ref}}$", "$err^{INT_{med}}$", "$err^{PIE}$", 
             "$prop^{err^{CDE}}$", 
             "$prop^{err^{INT_{ref}}}$", "$prop^{err^{INT_{med}}}$", 
             "$prop^{err^{PIE}}$", "$overall^{PM}$", "$overall^{INT}$", "$overall^{PE}$"),
           c("$E[Y_{am}]/E[Y_{a^*m}]$", "$E[Y_{aM_a^*}]/E[Y_{a^*M_a^*}]$", 
             "$E[Y_{aM_a}]/E[Y_{a^*M_a}]$", "$E[Y_{a^*M_a}]/E[Y_{a^*M_a^*}]$", 
             "$E[Y_{a^*M_a}]/E[Y_{a^*M_a^*}]$", "$rr^{PNDE}\\times rr^{TNIE}$", 
             "$(rr^{PNDE}*(rr^{TNIE}-1))/(rr^{TE}-1)$", "$(E[Y_{am}-Y_{a^*m}])/E[Y_{a^*M_a^*}]$",
             "$rr^{PNDE}-1-err^{CDE}$", "$rr^{TNIE}*rr^{PNDE}-rr^{PNDE}-rr^{PNIE}+1$", 
             "$rr^{PNIE}-1$", "$\frac{err^{CDE}}{err^{TE}}$", 
             "$\frac{err^{INT_{ref}}}{err^{TE}}$", 
             "$\frac{err^{INT_{med}}}{err^{TE}}$", "$\frac{err^{PIE}}{err^{TE}}$", 
             "$(err^{PIE}+err^{INT_{med}})/err^{TE}$", 
             "$(err^{INT_{ref}}+err^{INT_{med}})/err^{TE}$", 
             "$(err^{INT_{ref}}+err^{INT_{med}}+err^{PIE})/err^{TE}$"))
colnames(tb2) <- c("Full Name", "Abbreviation", "Formula")
knitr::kable(tb2, escape = FALSE, caption = "Description of Causal Effects on the Difference Scale") %>%
  footnote(general = "$a$ and $a^*$ are two reference values of the exposure. $m$ is the reference value of the mediator. $M_a$ denote the counterfactual values of $M$ if A is set to be $a$. $Y_{am}$ denote the counterfactual values of $Y$ if $M$ is set to be $m$ and A is set to be $a$. $Y_{aMa*}$ denotes the counterfactual value of $Y$ if $A$ is set to be $a$ and M is set to be $M_a^*$. $RR$ and $rr$ represents relative risk or rate ratio.") %>%
  column_spec(1, width = "20em") %>%
  column_spec(2, width = "8em") %>%
  column_spec(3, width = "10em") %>%
  kable_styling(bootstrap_options = c("bordered", "striped", "hover", "responsive"))
```

For categorical, count, and survival outcome, causal effects are estimated on the ratio scale. We directly estimate $rr^{CDE}$, $rr^{PNDE}$, $rr^{TNDE}$, $rr^{PNIE}$, $rr^{TNIE}$ and $err^{CDE}$ and other effects are calculated from $rr^{CDE}$, $rr^{PNDE}$, $rr^{TNDE}$, $rr^{PNIE}$, $rr^{TNIE}$ and $err^{CDE}$. 

## The Regression-based Approach

Via the regression-based approach, all causal effects can be estimated through closed-form parameter function estimation or direct counterfactual imputation estimation.

### Closed-form Parameter Function Estimation

We allow for the closed-form parameter function estimation when there is only a single mediator, i.e. $M=M_1$. The causal effects estimated through closed-form parameter function estimation are effects conditional on values of pre-exposure confounders.

#### Continuous Outcome, Continuous Mediator and Continuous Exposure

Fit a simple linear regression model for the mediator:
$$E[M|a,c]=\beta_0+\beta_1a+\beta_2'c$$

Fit a simple linear regression model for the outcome:
$$E[Y|a,m,c]=\theta_0+\theta_1a+\theta_2m+\theta_3am+\theta_4'c$$

Closed-form parameter function estimators for $CDE$, $PNDE$, $TNDE$, $PNIE$ and $TNIE$ are:

$CDE=(\theta_1+\theta_3m)(a-a^*)$

$PNDE=\{\theta_1+\theta_3(\beta_0+\beta_1a^*+\beta_2'c)\}(a-a^*)$

$TNDE=\{\theta_1+\theta_3(\beta_0+\beta_1a+\beta_2'c)\}(a-a^*)$

$PNIE=(\theta_2\beta_1+\theta_3\beta_1a^*)(a-a^*)$

$TNIE=(\theta_2\beta_1+\theta_3\beta_1a)(a-a^*)$

#### Continuous Outcome, Continuous Mediator and Categorical Exposure

Fit a simple linear regression model for the mediator:
$$E[M|a,c]=\beta_0+\sum_{k=1}^K\beta_{1k}I\{a=k\}+\beta_2'c$$

Fit a simple linear regression model for the outcome:
$$E[Y|a,m,c]=\theta_0+\sum_{k=1}^K\theta_{1k}I\{a=k\}+\theta_2m+\sum_{k=1}^K\theta_{3k}I\{a=k\}m+\theta_4'c$$

Closed-form parameter function estimators for $CDE$, $PNDE$, $TNDE$, $PNIE$ and $TNIE$ are:

$CDE=(\sum_{k=1}^K\theta_{1k}I\{a=k\}-\sum_{k=1}^K\theta_{1k}I\{a^*=k\})+(\sum_{k=1}^K\theta_{3k}I\{a=k\}-\sum_{k=1}^K\theta_{3k}I\{a^*=k\})m$

$PNDE=(\sum_{k=1}^K\theta_{1k}I\{a=k\}-\sum_{k=1}^K\theta_{1k}I\{a^*=k\})+(\sum_{k=1}^K\theta_{3k}I\{a=k\}-\sum_{k=1}^K\theta_{3k}I\{a^*=k\})(\beta_0+\sum_{k=1}^K\beta_{1k}I\{a^*=k\}+\beta_2'c)$

$TNDE=(\sum_{k=1}^K\theta_{1k}I\{a=k\}-\sum_{k=1}^K\theta_{1k}I\{a^*=k\})+(\sum_{k=1}^K\theta_{3k}I\{a=k\}-\sum_{k=1}^K\theta_{3k}I\{a^*=k\})(\beta_0+\sum_{k=1}^K\beta_{1k}I\{a=k\}+\beta_2'c)$

$PNIE=(\theta_2+\sum_{k=1}^K\theta_{3k}I\{a^*=k\})(\sum_{k=1}^K\beta_{1k}I\{a=k\}-\sum_{k=1}^K\beta_{1k}I\{a^*=k\})$

$TNIE=(\theta_2+\sum_{k=1}^K\theta_{3k}I\{a=k\})(\sum_{k=1}^K\beta_{1k}I\{a=k\}-\sum_{k=1}^K\beta_{1k}I\{a^*=k\})$

#### Continuous Outcome, Binary Mediator and Continuous Exposure

Fit a logistic regression model for the mediator:
$$logitE[M|a,c]=\beta_0+\beta_1a+\beta_2'c$$

Fit a simple linear regression model for the outcome:
$$E[Y|a,m,c]=\theta_0+\theta_1a+\theta_2m+\theta_3am+\theta_4'c$$

Closed-form parameter function estimators for $CDE$, $PNDE$, $TNDE$, $PNIE$ and $TNIE$ are:

$CDE=(\theta_1+\theta_3m)(a-a^*)$

$PNDE=\{\theta_1+\theta_3\frac{exp(\beta_0+\beta_1a^*+\beta_2'c)}{1+exp(\beta_0+\beta_1a^*+\beta_2'c)}\}(a-a^*)$

$TNDE=\{\theta_1+\theta_3\frac{exp(\beta_0+\beta_1a+\beta_2'c)}{1+exp(\beta_0+\beta_1a+\beta_2'c)}\}(a-a^*)$

$PNIE=(\theta_2+\theta_3a^*)(\frac{exp(\beta_0+\beta_1a+\beta_2'c)}{1+exp(\beta_0+\beta_1a+\beta_2'c)}-\frac{exp(\beta_0+\beta_1a^*+\beta_2'c)}{1+exp(\beta_0+\beta_1a^*+\beta_2'c)})$

$TNIE=(\theta_2+\theta_3a)(\frac{exp(\beta_0+\beta_1a+\beta_2'c)}{1+exp(\beta_0+\beta_1a+\beta_2'c)}-\frac{exp(\beta_0+\beta_1a^*+\beta_2'c)}{1+exp(\beta_0+\beta_1a^*+\beta_2'c)})$

#### Continuous Outcome, Binary Mediator and Categorical Exposure

Fit a logistic regression model for the mediator:
$$logitE[M|a,c]=\beta_0+\sum_{k=1}^K\beta_{1k}I\{a=k\}+\beta_2'c$$

Fit a simple linear regression model for the outcome:
$$E[Y|a,m,c]=\theta_0+\sum_{k=1}^K\theta_{1k}I\{a=k\}+\theta_2m+\sum_{k=1}^K\theta_{3k}I\{a=k\}m+\theta_4'c$$

Closed-form parameter function estimators for $CDE$, $PNDE$, $TNDE$, $PNIE$ and $TNIE$ are:

$CDE=(\sum_{k=1}^K\theta_{1k}I\{a=k\}-\sum_{k=1}^K\theta_{1k}I\{a^*=k\})+(\sum_{k=1}^K\theta_{3k}I\{a=k\}-\sum_{k=1}^K\theta_{3k}I\{a^*=k\})m$

$PNDE=(\sum_{k=1}^K\theta_{1k}I\{a=k\}-\sum_{k=1}^K\theta_{1k}I\{a^*=k\})+(\sum_{k=1}^K\theta_{3k}I\{a=k\}-\sum_{k=1}^K\theta_{3k}I\{a^*=k\})\frac{exp(\beta_0+\sum_{k=1}^K\beta_{1k}I\{a^*=k\}+\beta_2'c)}{1+exp(\beta_0+\sum_{k=1}^K\beta_{1k}I\{a^*=k\}+\beta_2'c)}$

$TNDE=(\sum_{k=1}^K\theta_{1k}I\{a=k\}-\sum_{k=1}^K\theta_{1k}I\{a^*=k\})+(\sum_{k=1}^K\theta_{3k}I\{a=k\}-\sum_{k=1}^K\theta_{3k}I\{a^*=k\})\frac{exp(\beta_0+\sum_{k=1}^K\beta_{1k}I\{a=k\}+\beta_2'c)}{1+exp(\beta_0+\sum_{k=1}^K\beta_{1k}I\{a=k\}+\beta_2'c)}$

$PNIE=(\theta_2+\sum_{k=1}^K\theta_{3k}I\{a^*=k\})(\frac{exp(\beta_0+\sum_{k=1}^K\beta_{1k}I\{a=k\}+\beta_2'c)}{1+exp(\beta_0+\sum_{k=1}^K\beta_{1k}I\{a=k\}+\beta_2'c)}-\frac{exp(\beta_0+\sum_{k=1}^K\beta_{1k}I\{a^*=k\}+\beta_2'c)}{1+exp(\beta_0+\sum_{k=1}^K\beta_{1k}I\{a^*=k\}+\beta_2'c)})$

$TNIE=(\theta_2+\sum_{k=1}^K\theta_{3k}I\{a=k\})(\frac{exp(\beta_0+\sum_{k=1}^K\beta_{1k}I\{a=k\}+\beta_2'c)}{1+exp(\beta_0+\sum_{k=1}^K\beta_{1k}I\{a=k\}+\beta_2'c)}-\frac{exp(\beta_0+\sum_{k=1}^K\beta_{1k}I\{a^*=k\}+\beta_2'c)}{1+exp(\beta_0+\sum_{k=1}^K\beta_{1k}I\{a^*=k\}+\beta_2'c)})$
 
#### Continuous Outcome, Categorical Mediator and Continuous Exposure

Fit a multinomial regression model for the mediator:
$$log\frac{E[M=j|a,c]}{E[M=0|a,c]}=\beta_{0j}+\beta_{1j}a+\beta_{2j}'c, j=1,2,...,l$$

Fit a simple linear regression model for the outcome:
$$E[Y|a,m,c]=\theta_0+\theta_1a+\sum_{j=1}^l\theta_{2j}I\{m=j\}+a\sum_{j=1}^l\theta_{3j}I\{m=j\}+\theta_4'c$$

Closed-form parameter function estimators for $CDE$, $PNDE$, $TNDE$, $PNIE$ and $TNIE$ are:

$CDE=(\theta_1+\sum_{j=1}^l\theta_{3j}I\{m=j\})(a-a^*)$

$PNDE=\{\theta_1+\frac{\sum_{j=1}^l\theta_{3j}exp(\beta_{0j}+\beta_{1j}a^*+\beta_{2j}'c)}{1+\sum_{j=1}^lexp(\beta_{0j}+\beta_{1j}a^*+\beta_{2j}'c)}\}(a-a^*)$

$TNDE=\{\theta_1+\frac{\sum_{j=1}^l\theta_{3j}exp(\beta_{0j}+\beta_{1j}a+\beta_{2j}'c)}{1+\sum_{j=1}^lexp(\beta_{0j}+\beta_{1j}a+\beta_{2j}'c)}\}(a-a^*)$

$PNIE=\frac{\sum_{j=1}^l(\theta_{2j}+\theta_{3j}a^*)exp(\beta_{0j}+\beta_{1j}a+\beta_{2j}'c)}{1+\sum_{j=1}^lexp(\beta_{0j}+\beta_{1j}a+\beta_{2j}'c)}-\frac{\sum_{j=1}^l(\theta_{2j}+\theta_{3j}a^*)exp(\beta_{0j}+\beta_{1j}a^*+\beta_{2j}'c)}{1+\sum_{j=1}^lexp(\beta_{0j}+\beta_{1j}a^*+\beta_{2j}'c)}$

$TNIE=\frac{\sum_{j=1}^l(\theta_{2j}+\theta_{3j}a)exp(\beta_{0j}+\beta_{1j}a+\beta_{2j}'c)}{1+\sum_{j=1}^lexp(\beta_{0j}+\beta_{1j}a+\beta_{2j}'c)}-\frac{\sum_{j=1}^l(\theta_{2j}+\theta_{3j}a)exp(\beta_{0j}+\beta_{1j}a^*+\beta_{2j}'c)}{1+\sum_{j=1}^lexp(\beta_{0j}+\beta_{1j}a^*+\beta_{2j}'c)}$

#### Continuous Outcome, Categorical Mediator and Categorical Exposure

Fit a multinomial regression model for the mediator:
$$log\frac{E[M=j|a,c]}{E[M=0|a,c]}=\beta_{0j}+\sum_{k=1}^K\beta_{1jk}I\{a=k\}+\beta_{2j}'c, j=1,2,...,l$$

Fit a simple linear regression model for the outcome:
$$E[Y|a,m,c]=\theta_0+\sum_{k=1}^K\theta_{1k}I\{a=k\}+\sum_{j=1}^l\theta_{2j}I\{m=j\}+\sum_{j=1}^l\sum_{k=1}^K\theta_{3jk}I\{m=j\}I\{a=k\}+\theta_4'c$$ 

Closed-form parameter function estimators for $CDE$, $PNDE$, $TNDE$, $PNIE$ and $TNIE$ are:

$CDE=(\sum_{k=1}^K\theta_{1k}I\{a=k\}-\sum_{k=1}^K\theta_{1k}I\{a^*=k\})+(\sum_{j=1}^l\sum_{k=1}^K\theta_{3jk}I\{m=j\}I\{a=k\}-\sum_{j=1}^l\sum_{k=1}^K\theta_{3jk}I\{m=j\}I\{a^*=k\})$

$PNDE=(\sum_{k=1}^K\theta_{1k}I\{a=k\}-\sum_{k=1}^K\theta_{1k}I\{a^*=k\})+\frac{\sum_{j=1}^l(\sum_{k=1}^K\theta_{3jk}I\{a=k\}-\sum_{k=1}^K\theta_{3jk}I\{a^*=k\})exp(\beta_{0j}+\sum_{k=1}^K\beta_{1jk}I\{a^*=k\}+\beta_{2j}'c)}{1+\sum_{j=1}^lexp(\beta_{0j}+\sum_{k=1}^K\beta_{1jk}I\{a^*=k\}+\beta_{2j}'c)}$

$TNDE=(\sum_{k=1}^K\theta_{1k}I\{a=k\}-\sum_{k=1}^K\theta_{1k}I\{a^*=k\})+\frac{\sum_{j=1}^l(\sum_{k=1}^K\theta_{3jk}I\{a=k\}-\sum_{k=1}^K\theta_{3jk}I\{a^*=k\})exp(\beta_{0j}+\sum_{k=1}^K\beta_{1jk}I\{a=k\}+\beta_{2j}'c)}{1+\sum_{j=1}^lexp(\beta_{0j}+\sum_{k=1}^K\beta_{1jk}I\{a=k\}+\beta_{2j}'c)}$

$PNIE=\frac{\sum_{j=1}^l(\theta_{2j}+\sum_{k=1}^K\theta_{3jk}I\{a^*=k\})exp(\beta_{0j}+\sum_{k=1}^K\beta_{1jk}I\{a=k\}+\beta_{2j}'c)}{1+\sum_{j=1}^lexp(\beta_{0j}+\sum_{k=1}^K\beta_{1jk}I\{a=k\}+\beta_{2j}'c)}-\frac{\sum_{j=1}^l(\theta_{2j}+\sum_{k=1}^K\theta_{3jk}I\{a^*=k\})exp(\beta_{0j}+\sum_{k=1}^K\beta_{1jk}I\{a^*=k\}+\beta_{2j}'c)}{1+\sum_{j=1}^lexp(\beta_{0j}+\sum_{k=1}^K\beta_{1jk}I\{a^*=k\}+\beta_{2j}'c)}$

$TNIE=\frac{\sum_{j=1}^l(\theta_{2j}+\sum_{k=1}^K\theta_{3jk}I\{a=k\})exp(\beta_{0j}+\sum_{k=1}^K\beta_{1jk}I\{a=k\}+\beta_{2j}'c)}{1+\sum_{j=1}^lexp(\beta_{0j}+\sum_{k=1}^K\beta_{1jk}I\{a=k\}+\beta_{2j}'c)}-\frac{\sum_{j=1}^l(\theta_{2j}+\sum_{k=1}^K\theta_{3jk}I\{a=k\})exp(\beta_{0j}+\sum_{k=1}^K\beta_{1jk}I\{a^*=k\}+\beta_{2j}'c)}{1+\sum_{j=1}^lexp(\beta_{0j}+\sum_{k=1}^K\beta_{1jk}I\{a^*=k\}+\beta_{2j}'c)}$

#### Binary Outcome, Continuous Mediator and Continuous Exposure

Fit a simple linear regression model for the mediator:
$$E[M|a,c]=\beta_0+\beta_1a+\beta_2'c$$

Fit a logistic regression model for the outcome:
$$logitE[Y|a,m,c]=\theta_0+\theta_1a+\theta_2m+\theta_3am+\theta_4'c$$

Closed-form parameter function estimators for $rr^{CDE}$, $rr^{PNDE}$, $rr^{TNDE}$, $rr^{PNIE}$, $rr^{TNIE}$ and $err^{CDE}$ are:

$rr^{CDE}=exp((\theta_1+\theta_3m)(a-a^*))$

$rr^{PNDE}=exp(\{\theta_1+\theta_3(\beta_0+\beta_1a^*+\beta_2'c+\theta_2\sigma^2)\}(a-a^*)+0.5\theta_3^2\sigma^2(a^2-a^{*2}))$

$rr^{TNDE}=exp(\{\theta_1+\theta_3(\beta_0+\beta_1a+\beta_2'c+\theta_2\sigma^2)\}(a-a^*)+0.5\theta_3^2\sigma^2(a^2-a^{*2}))$

$rr^{PNIE}=exp((\theta_2\beta_1+\theta_3\beta_1a^*)(a-a^*))$

$rr^{TNIE}=exp((\theta_2\beta_1+\theta_3\beta_1a)(a-a^*))$

$err^{CDE}=(exp(\theta_1(a-a^*)+\theta_3am)-exp(\theta_3a^*m))exp(\theta_2m-(\theta_2+\theta_3a^*)(\beta_0+\beta_1a^*+\beta_2'c)-0.5(\theta_2+\theta_3a^*)^2\sigma^2)$

#### Binary Outcome, Continuous Mediator and Categorical Exposure

Fit a simple linear regression model for the mediator:
$$E[M|a,c]=\beta_0+\sum_{k=1}^K\beta_{1k}I\{a=k\}+\beta_2'c$$

Fit a logistic regression model for the outcome:
$$logitE[Y|a,m,c]=\theta_0+\sum_{k=1}^K\theta_{1k}I\{a=k\}+\theta_2m+\sum_{k=1}^K\theta_{3k}I\{a=k\}m+\theta_4'c$$

Closed-form parameter function estimators for $rr^{CDE}$, $rr^{PNDE}$, $rr^{TNDE}$, $rr^{PNIE}$, $rr^{TNIE}$ and $err^{CDE}$ are:

$rr^{CDE}=exp((\sum_{k=1}^K\theta_{1k}I\{a=k\}-\sum_{k=1}^K\theta_{1k}I\{a^*=k\})+(\sum_{k=1}^K\theta_{3k}I\{a=k\}-\sum_{k=1}^K\theta_{3k}I\{a^*=k\})m)$

$rr^{PNDE}=exp((\{\sum_{k=1}^K\theta_{1k}I\{a=k\}-\sum_{k=1}^K\theta_{1k}I\{a^*=k\})+(\sum_{k=1}^K\theta_{3k}I\{a=k\}-\sum_{k=1}^K\theta_{3k}I\{a^*=k\})(\beta_0+\sum_{k=1}^K\beta_{1k}I\{a^*=k\}+\beta_2'c+\theta_2\sigma^2)+0.5\sigma^2(\sum_{k=1}^K\theta_{3k}^2I\{a=k\}-\sum_{k=1}^K\theta_{3k}^2I\{a^*=k\}))$

$rr^{TNDE}=exp((\sum_{k=1}^K\theta_{1k}I\{a=k\}-\sum_{k=1}^K\theta_{1k}I\{a^*=k\})+(\sum_{k=1}^K\theta_{3k}I\{a=k\}-\sum_{k=1}^K\theta_{3k}I\{a^*=k\})(\beta_0+\sum_{k=1}^K\beta_{1k}I\{a=k\}+\beta_2'c+\theta_2\sigma^2)+0.5\sigma^2(\sum_{k=1}^K\theta_{3k}^2I\{a=k\}-\sum_{k=1}^K\theta_{3k}^2I\{a^*=k\}))$

$rr^{PNIE}=exp(\theta_2(\sum_{k=1}^K\beta_{1k}I\{a=k\}-\sum_{k=1}^K\beta_{1k}I\{a^*=k\})+\sum_{k=1}^K\theta_{3k}I\{a^*=k\}(\sum_{k=1}^K\beta_{1k}I\{a=k\}-\sum_{k=1}^K\beta_{1k}I\{a^*=k\}))$

$rr^{TNIE}=exp(\theta_2(\sum_{k=1}^K\beta_{1k}I\{a=k\}-\sum_{k=1}^K\beta_{1k}I\{a^*=k\})+\sum_{k=1}^K\theta_{3k}I\{a=k\}(\sum_{k=1}^K\beta_{1k}I\{a=k\}-\sum_{k=1}^K\beta_{1k}I\{a^*=k\}))$

$err^{CDE}=(exp((\sum_{k=1}^K\theta_{1k}I\{a=k\}-\sum_{k=1}^K\theta_{1k}I\{a^*=k\})+\sum_{k=1}^K\theta_{3k}I\{a=k\}m)-exp(\sum_{k=1}^K\theta_{3k}I\{a^*=k\}m))exp(\theta_2m-(\theta_2+\sum_{k=1}^K\theta_{3k}I\{a^*=k\})(\beta_0+\sum_{k=1}^K\beta_{1k}I\{a^*=k\}+\beta_2'c)-0.5(\theta_2+\sum_{k=1}^K\theta_{3k}I\{a^*=k\})^2\sigma^2)$

#### Binary Outcome, Binary Mediator and Continuous Exposure

Fit a logistic regression model for the mediator:
$$logitE[M|a,c]=\beta_0+\beta_1a+\beta_2'c$$

Fit a logistic regression model for the outcome:
$$logitE[Y|a,m,c]=\theta_0+\theta_1a+\theta_2m+\theta_3am+\theta_4'c$$

Closed-form parameter function estimators for $rr^{CDE}$, $rr^{PNDE}$, $rr^{TNDE}$, $rr^{PNIE}$, $rr^{TNIE}$ and $err^{CDE}$ are:

$rr^{CDE}=exp((\theta_1+\theta_3m)(a-a^*))$

$rr^{PNDE}=\frac{exp(\theta_1a)\{1+exp(\theta_2+\theta_3a+\beta_0+\beta_1a^*+\beta_2'c)\}}{exp(\theta_1a^*)\{1+exp(\theta_2+\theta_3a^*+\beta_0+\beta_1a^*+\beta_2'c)\}}$

$rr^{TNDE}=\frac{exp(\theta_1a)\{1+exp(\theta_2+\theta_3a+\beta_0+\beta_1a+\beta_2'c)\}}{exp(\theta_1a^*)\{1+exp(\theta_2+\theta_3a^*+\beta_0+\beta_1a+\beta_2'c)\}}$

$rr^{PNIE}=\frac{\{1+exp(\beta_0+\beta_1a^*+\beta_2'c)\}\{1+exp(\theta_2+\theta_3a^*+\beta_0+\beta_1a+\beta_2'c)\}}{\{1+exp(\beta_0+\beta_1a+\beta_2'c)\}\{1+exp(\theta_2+\theta_3a^*+\beta_0+\beta_1a^*+\beta_2'c)\}}$

$rr^{TNIE}=\frac{\{1+exp(\beta_0+\beta_1a^*+\beta_2'c)\}\{1+exp(\theta_2+\theta_3a+\beta_0+\beta_1a+\beta_2'c)\}}{\{1+exp(\beta_0+\beta_1a+\beta_2'c)\}\{1+exp(\theta_2+\theta_3a+\beta_0+\beta_1a^*+\beta_2'c)\}}$

$err^{CDE}=\frac{exp(\theta_2m)(exp(\theta_1(a-a^*)+\theta_3am)-exp(\theta_3a^*m))(1+exp(\beta_0+\beta_1a^*+\beta_2'c))}{1+exp(\beta_0+\beta_1a^*+\beta_2'c+\theta_2+\theta_3a^*)}$

#### Binary Outcome, Binary Mediator and Categorical Exposure

Fit a logistic regression model for the mediator:
$$logitE[M|a,c]=\beta_0+\sum_{k=1}^K\beta_{1k}I\{a=k\}+\beta_2'c$$

Fit a logistic regression model for the outcome:
$$logitE[Y|a,m,c]=\theta_0+\sum_{k=1}^K\theta_{1k}I\{a=k\}+\theta_2m+\sum_{k=1}^K\theta_{3k}I\{a=k\}m+\theta_4'c$$

Closed-form parameter function estimators for $rr^{CDE}$, $rr^{PNDE}$, $rr^{TNDE}$, $rr^{PNIE}$, $rr^{TNIE}$ and $err^{CDE}$ are:

$rr^{CDE}=exp((\sum_{k=1}^K\theta_{1k}I\{a=k\}-\sum_{k=1}^K\theta_{1k}I\{a^*=k\})+(\sum_{k=1}^K\theta_{3k}I\{a=k\}-\sum_{k=1}^K\theta_{3k}I\{a^*=k\})m)$

$rr^{PNDE}=\frac{exp(\sum_{k=1}^K\theta_{1k}I\{a=k\})\{1+exp(\theta_2+\sum_{k=1}^K\theta_{3k}I\{a=k\}+\beta_0+\sum_{k=1}^K\beta_{1k}I\{a^*=k\}+\beta_2'c)\}}{exp(\sum_{k=1}^K\theta_{1k}I\{a^*=k\})\{1+exp(\theta_2+\sum_{k=1}^K\theta_{3k}I\{a^*=k\}+\beta_0+\sum_{k=1}^K\beta_{1k}I\{a^*=k\}+\beta_2'c)\}}$

$rr^{TNDE}=\frac{exp(\sum_{k=1}^K\theta_{1k}I\{a=k\})\{1+exp(\theta_2+\sum_{k=1}^K\theta_{3k}I\{a=k\}+\beta_0+\sum_{k=1}^K\beta_{1k}I\{a=k\}+\beta_2'c)\}}{exp(\sum_{k=1}^K\theta_{1k}I\{a^*=k\})\{1+exp(\theta_2+\sum_{k=1}^K\theta_{3k}I\{a^*=k\}+\beta_0+\sum_{k=1}^K\beta_{1k}I\{a=k\}+\beta_2'c)\}}$

$rr^{PNIE}=\frac{\{1+exp(\beta_0+\sum_{k=1}^K\beta_{1k}I\{a^*=k\}+\beta_2'c)\}\{1+exp(\theta_2+\sum_{k=1}^K\theta_{3k}I\{a^*=k\}+\beta_0+\sum_{k=1}^K\beta_{1k}I\{a=k\}+\beta_2'c)\}}{\{1+exp(\beta_0+\sum_{k=1}^K\beta_{1k}I\{a=k\}+\beta_2'c)\}\{1+exp(\theta_2+\sum_{k=1}^K\theta_{3k}I\{a^*=k\}+\beta_0+\sum_{k=1}^K\beta_{1k}I\{a^*=k\}+\beta_2'c)\}}$

$rr^{TNIE}=\frac{\{1+exp(\beta_0+\sum_{k=1}^K\beta_{1k}I\{a^*=k\}+\beta_2'c)\}\{1+exp(\theta_2+\sum_{k=1}^K\theta_{3k}I\{a=k\}+\beta_0+\sum_{k=1}^K\beta_{1k}I\{a=k\}+\beta_2'c)\}}{\{1+exp(\beta_0+\sum_{k=1}^K\beta_{1k}I\{a=k\}+\beta_2'c)\}\{1+exp(\theta_2+\sum_{k=1}^K\theta_{3k}I\{a=k\}+\beta_0+\sum_{k=1}^K\beta_{1k}I\{a^*=k\}+\beta_2'c)\}}$

$err^{CDE}=\frac{exp(\theta_2m)(exp((\sum_{k=1}^K\theta_{1k}I\{a=k\}-\sum_{k=1}^K\theta_{1k}I\{a^*=k\})+\sum_{k=1}^K\theta_{3k}I\{a=k\}m)-exp(\sum_{k=1}^K\theta_{3k}I\{a^*=k\}m))(1+exp(\beta_0+\sum_{k=1}^K\beta_{1k}I\{a^*=k\}+\beta_2'c))}{(1+exp(\beta_0+\sum_{k=1}^K\beta_{1k}I\{a^*=k\}+\beta_2'c+\theta_2+\sum_{k=1}^K\theta_{3k}I\{a^*=k\}))(1+exp(\beta_0+\sum_{k=1}^K\beta_{1k}I\{a^*=k\}+\beta_2'c+\theta_2+\sum_{k=1}^K\theta_{3k}I\{a^*=k\}))}$

#### Binary Outcome, Categorical Mediator and Continuous Exposure

Fit a multinomial regression model for the mediator:

$$log\frac{E[M=j|a,c]}{E[M=0|a,c]}=\beta_{0j}+\beta_{1j}a+\beta_{2j}'c, j=1,2,...,l$$

Fit a logistic regression model for the outcome:
$$logitE[Y|a,m,c]=\theta_0+\theta_1a+\sum_{j=1}^l\theta_{2j}I\{m=j\}+a\sum_{j=1}^l\theta_{3j}I\{m=j\}+\theta_4'c$$

Closed-form parameter function estimators for $rr^{CDE}$, $rr^{PNDE}$, $rr^{TNDE}$, $rr^{PNIE}$, $rr^{TNIE}$ and $err^{CDE}$ are:

$rr^{CDE}=exp((\theta_1+\sum_{j=1}^l\theta_{3j}I\{m=j\})(a-a^*))$

$rr^{PNDE}=\frac{exp(\theta_1a)\{1+\sum_{j=1}^lexp(\theta_{2j}+\theta_{3j}a+\beta_{0j}+\beta_{1j}a^*+\beta_{2j}'c)\}}{exp(\theta_1a^*)\{1+\sum_{j=1}^lexp(\theta_{2j}+\theta_{3j}a^*+\beta_{0j}+\beta_{1j}a^*+\beta_{2j}'c)\}}$

$rr^{TNDE}=\frac{exp(\theta_1a)\{1+\sum_{j=1}^lexp(\theta_{2j}+\theta_{3j}a+\beta_{0j}+\beta_{1j}a+\beta_{2j}'c)\}}{exp(\theta_1a^*)\{1+\sum_{j=1}^lexp(\theta_{2j}+\theta_{3j}a^*+\beta_{0j}+\beta_{1j}a+\beta_{2j}'c)\}}$

$rr^{PNIE}=\frac{\{1+\sum_{j=1}^lexp(\beta_{0j}+\beta_{1j}a^*+\beta_{2j}'c)\}\{1+\sum_{j=1}^lexp(\theta_{2j}+\theta_{3j}a^*+\beta_{0j}+\beta_{1j}a+\beta_{2j}'c)\}}{\{1+\sum_{j=1}^lexp(\beta_{0j}+\beta_{1j}a+\beta_{2j}'c)\}\{1+\sum_{j=1}^lexp(\theta_{2j}+\theta_{3j}a^*+\beta_{0j}+\beta_{1j}a^*+\beta_{2j}'c)\}}$

$rr^{TNIE}=\frac{\{1+\sum_{j=1}^lexp(\beta_{0j}+\beta_{1j}a^*+\beta_{2j}'c)\}\{1+\sum_{j=1}^lexp(\theta_{2j}+\theta_{3j}a+\beta_{0j}+\beta_{1j}a+\beta_{2j}'c)\}}{\{1+\sum_{j=1}^lexp(\beta_{0j}+\beta_{1j}a+\beta_{2j}'c)\}\{1+\sum_{j=1}^lexp(\theta_{2j}+\theta_{3j}a+\beta_{0j}+\beta_{1j}a^*+\beta_{2j}'c)\}}$

$err^{CDE}=\frac{exp(\sum_{j=1}^l\theta_{2j}I\{m=j\})(1+\sum_{j=1}^lexp(\beta_{0j}+\beta_{1j}a^*+\beta_{2j}'c))(exp(\theta_1(a-a^*)+a\sum_{j=1}^l\theta_{3j}I\{m=j\})-exp(a^*\sum_{j=1}^l\theta_{3j}I\{m=j\}))}{1+\sum_{j=1}^lexp(\theta_{2j}+\theta_{3j}a^*+\beta_{0j}+\beta_{1j}a^*+\beta_{2j}'c)}$

#### Binary Outcome, Categorical Mediator and Categorical Exposure

Fit a multinomial regression model for the mediator:

$$log\frac{E[M=j|a,c]}{E[M=0|a,c]}=\beta_{0j}+\sum_{k=1}^K\beta_{1jk}I\{a=k\}+\beta_{2j}'c, j=1,2,...,l$$

Fit a logistic regression model for the outcome:
$$logitE[Y|a,m,c]=\theta_0+\sum_{k=1}^K\theta_{1k}I\{a=k\}+\sum_{j=1}^l\theta_{2j}I\{m=j\}+\sum_{j=1}^l\sum_{k=1}^K\theta_{3jk}I\{m=j\}I\{a=k\}+\theta_4'c$$ 

Closed-form parameter function estimators for $rr^{CDE}$, $rr^{PNDE}$, $rr^{TNDE}$, $rr^{PNIE}$, $rr^{TNIE}$ and $err^{CDE}$ are:

$rr^{CDE}=exp((\sum_{k=1}^K\theta_{1k}I\{a=k\}-\sum_{k=1}^K\theta_{1k}I\{a^*=k\})+(\sum_{j=1}^l\sum_{k=1}^K\theta_{3jk}I\{m=l\}I\{a=k\}-\sum_{j=1}^l\sum_{k=1}^K\theta_{3jk}I\{m=l\}I\{a^*=k\}))$

$rr^{PNDE}=\frac{exp(\sum_{k=1}^K\theta_{1k}I\{a=k\})\{1+\sum_{j=1}^lexp(\theta_{2j}+\sum_{k=1}^K\theta_{3jk}I\{a=k\}+\beta_{0j}+\sum_{k=1}^K\beta_{1jk}I\{a^*=k\}+\beta_{2j}'c)\}}{exp(\sum_{k=1}^K\theta_{1k}I\{a^*=k\})\{1+\sum_{j=1}^lexp(\theta_{2j}+\sum_{k=1}^K\theta_{3jk}I\{a^*=k\}+\beta_{0j}+\sum_{k=1}^K\beta_{1jk}I\{a^*=k\}+\beta_{2j}'c)\}}$

$rr^{TNDE}=\frac{exp(\sum_{k=1}^K\theta_{1k}I\{a=k\})\{1+\sum_{j=1}^lexp(\theta_{2j}+\sum_{k=1}^K\theta_{3jk}I\{a=k\}+\beta_{0j}+\sum_{k=1}^K\beta_{1jk}I\{a=k\}+\beta_{2j}'c)\}}{exp(\sum_{k=1}^K\theta_{1k}I\{a^*=k\})\{1+\sum_{j=1}^lexp(\theta_{2j}+\sum_{k=1}^K\theta_{3jk}I\{a^*=k\}+\beta_{0j}+\sum_{k=1}^K\beta_{1jk}I\{a=k\}+\beta_{2j}'c)\}}$

$rr^{PNIE}=\frac{\{1+\sum_{j=1}^lexp(\beta_{0j}+\sum_{k=1}^K\beta_{1jk}I\{a^*=k\}+\beta_{2j}'c)\}\{1+\sum_{j=1}^lexp(\theta_{2j}+\sum_{k=1}^K\theta_{3jk}I\{a^*=k\}+\beta_{0j}+\sum_{k=1}^K\beta_{1jk}I\{a=k\}+\beta_{2j}'c)\}}{\{1+\sum_{j=1}^lexp(\beta_{0j}+\sum_{k=1}^K\beta_{1jk}I\{a=k\}+\beta_{2j}'c)\}\{1+\sum_{j=1}^lexp(\theta_{2j}+\sum_{k=1}^K\theta_{3jk}I\{a^*=k\}+\beta_{0j}+\sum_{k=1}^K\beta_{1jk}I\{a^*=k\}+\beta_{2j}'c)\}}$

$rr^{TNIE}=\frac{\{1+\sum_{j=1}^lexp(\beta_{0j}+\sum_{k=1}^K\beta_{1jk}I\{a^*=k\}+\beta_{2j}'c)\}\{1+\sum_{j=1}^lexp(\theta_{2j}+\sum_{k=1}^K\theta_{3jk}I\{a=k\}+\beta_{0j}+\sum_{k=1}^K\beta_{1jk}I\{a=k\}+\beta_{2j}'c)\}}{\{1+\sum_{j=1}^lexp(\beta_{0j}+\sum_{k=1}^K\beta_{1jk}I\{a=k\}+\beta_{2j}'c)\}\{1+\sum_{j=1}^lexp(\theta_{2j}+\sum_{k=1}^K\theta_{3jk}I\{a=k\}+\beta_{0j}+\sum_{k=1}^K\beta_{1jk}I\{a^*=k\}+\beta_{2j}'c)\}}$

$err^{CDE}=\frac{exp(\sum_{j=1}^l\theta_{2j}I\{m=j\})(1+\sum_{j=1}^lexp(\beta_{0j}+\sum_{k=1}^K\beta_{1jk}I\{a^*=k\}+\beta_{2j}'c))(exp((\sum_{k=1}^K\theta_{1k}I\{a=k\}-\sum_{k=1}^K\theta_{1k}I\{a^*=k\})+\sum_{j=1}^l\sum_{k=1}^K\theta_{3jk}I\{a=k\}I\{m=j\})-exp(\sum_{j=1}^l\sum_{k=1}^K\theta_{3jk}I\{a^*=k\}I\{m=j\}))}{(1+\sum_{j=1}^lexp(\theta_{2j}+\sum_{k=1}^K\theta_{3jk}I\{a^*=k\}+\beta_{0j}+\sum_{k=1}^K\beta_{1jk}I\{a^*=k\}+\beta_{2j}'c))(1+\sum_{j=1}^lexp(\theta_{2j}+\sum_{k=1}^K\theta_{3jk}I\{a^*=k\}+\beta_{0j}+\sum_{k=1}^K\beta_{1jk}I\{a^*=k\}+\beta_{2j}'c))}$

### Direct Counterfactural Imputation Estimation

To estimate the causal effects, we need to impute the counterfactuals $E(Y_{am})$, $E(Y_{a^*m})$, $E[Y_{aMa^*}]$, $E[Y_{a^*Ma^*}]$, $E[Y_{aMa}]$ and $E[Y_{a^*Ma}]$. The steps of counterfactual imputation are:

1. Fit a regression model for $Y$ on $A$, $M$ and $C$.

2. Fit a regression model for each mediator $M_p,p=1,...,k$, on $A$, $M_1$, ..., $M_{p-1}$ and $C$.

For $E(Y_{am})$ and $E(Y_{a^*m})$: 

3. For each subject $i,i=1,...,n$, simulate $Y_{am,i}$ by the expected value of $Y_i$ given $A=a, M=m, C=C_i$ and simulate $Y_{a^*m,i}$ by the expected value of $Y_i$ given $A=a^*, M=m, C=C_i$. 

4. Impute $E[Y_{am}]$ and $E[Y_{a^*m}]$ by $\frac{\sum_{i=1}^NY_{am,i}}{n}$ and $\frac{\sum_{i=1}^NY_{a^*m,i}}{n}$ respectively.

For $E[Y_{aMa^*}]$, $E[Y_{a^*Ma^*}]$, $E[Y_{aMa}]$ and $E[Y_{a^*Ma}]$:

3. For each subject $i$ and each mediator $M_p$, simulate $M_{p,a,i}$ by randomly drawing a value from the distribution of $M_{p,i}$ given $A=a,M_1=M_{1,a,i},...,M_{p-1}=M_{p-1,a,i},C=C_i$; simulate $M_{p,a^*,i}$ by randomly drawing a value from the distribution of $M_{p,i}$ given $A=a^*,M_1=M_{1,a^*,i},...,M_{p-1}=M_{p-1,a^*,i},C=C_i$.

4. For each subject i, simulate $Y_{aMa^*,i}$ by the expected value of $Y_i$ given $A=a,M_1=M_{1,a^*,i},...,M_k=M_{k,a^*,i},C=C_i$; simulate $Y_{a^*Ma^*,i}$ by the expected value of $Y_i$ given $A=a^*,M_1=M_{1,a^*,i},...,M_k=M_{k,a^*,i},C=C_i$; simulate $Y_{aMa,i}$ by the expected value of $Y_i$ given $A=a,M_1=M_{1,a,i},...,M_k=M_{k,a,i},C=C_i$; simulate $Y_{a^*Ma,i}$ by the expected value of $Y_i$ given $A=a^*,M_1=M_{1,a,i},...,M_k=M_{k,a,i},C=C_i$.

5. Impute $E[Y_{aMa^*}]$, $E[Y_{a^*Ma^*}]$, $E[Y_{aMa}]$ and $E[Y_{a^*Ma}]$ by $\frac{\sum_{i=1}^NY_{aMa^*,i}}{n}$, $\frac{\sum_{i=1}^NY_{a^*Ma^*,i}}{n}$, $\frac{\sum_{i=1}^NY_{aMa,i}}{n}$, $\frac{\sum_{i=1}^NY_{a^*Ma,i}}{n}$.

